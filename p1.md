좋아, 지금 이 상태를 **“Frame 축 757 TCP 기준으로 바로잡은 버전”**으로 정리해서 줄게.
(= Frame 숫자는 **FWD 쪽으로 커지고**, 우리 x_from_mid_m 축은 **FWD 음수 / AFT 양수**로 맞춤)

아래 코드는 **agi_tr.py 안에서 교체하면 되는 패치 블록**이야.
파일 전체를 바꿀 필요 없이, 이 부분들만 갈아끼우면 된다.

---

## 1. Frame 매핑 상수 + fr_to_x / x_to_fr 패치

### (1) 상단 글로벌 상수 부분 교체

```python
# ============================================================================
# FRAME ↔ x_from_mid_m Mapping (BUSHRA 757 TCP aligned)
# ============================================================================

# BUSHRA Tank Plan 757 TCP 기준:
# - Frame 번호는 FWD 방향으로 증가
# - Midship ≈ Fr_mid = Lpp / 2 ≈ 30.151
# - 좌표계:  x_from_mid_m < 0.0  → FWD
#           x_from_mid_m > 0.0  → AFT
#
# ⇒ x = _FRAME_OFFSET + _FRAME_SLOPE * Fr
#    Fr_mid = 30.151  →  x = 0.0
#    큰 Frame(예: 48–65, FWB1/2 실제 위치) → x < 0.0 (FWD 쪽)
#    작은 Frame(예: 5–10)                → x > 0.0 (AFT 쪽)

_FRAME_SLOPE = -1.0        # x 는 Frame 이 커질수록 감소 (Frame 증가 = FWD)
_FRAME_OFFSET = 30.151     # Midship Frame → x = 0.0m
```

> **주의:** 예전 기본값은
> `_FRAME_SLOPE = 1.0`, `_FRAME_OFFSET = -30.15` (Fr 증가 = AFT) 였음.
> 이제 완전히 **뒤집어서 757 TCP 와 정합**시킨 상태.

---

### (2) fr_to_x / x_to_fr 함수 교체

기존 정의를 아래 코드로 교체해줘.

```python
def fr_to_x(fr: float) -> float:
    """
    Frame 번호 → x_from_mid_m (m) 변환.

    - 입력: Frame 번호 (Tank Plan 757 TCP 기준, FWD 방향으로 증가)
    - 출력: Midship 기준 x 좌표 (m)
        * x < 0.0  → FWD side
        * x > 0.0  → AFT side

    공식:
        x = _FRAME_OFFSET + _FRAME_SLOPE * Fr

    예시 (BUSHRA, Lpp ≈ 60.30m, Fr_mid ≈ 30.151):
        Fr = 30.151 → x ≈ 0.00 m  (Midship)
        Fr = 60.30  → x ≈ -30.15 m (Forward extremity)
        Fr = 0.00   → x ≈ +30.15 m (Aft extremity)
    """
    return _FRAME_OFFSET + _FRAME_SLOPE * float(fr)


def x_to_fr(x: float) -> float:
    """
    x_from_mid_m (m) → Frame 번호 역변환.

    fr_to_x() 의 정확한 역함수:
        Fr = (x - _FRAME_OFFSET) / _FRAME_SLOPE
    """
    return (float(x) - _FRAME_OFFSET) / _FRAME_SLOPE
```

---

### (3) Frame 매핑 자동 초기화(_init_frame_mapping) 기본값만 수정

`_init_frame_mapping()` 안에 **fallback** 부분(데이터 파일 없을 때 기본값 세팅)을 아래처럼 맞춰줘.

```python
def _init_frame_mapping():
    """
    Frame ↔ x_from_mid_m 매핑 초기화.
    data/Frame_x_from_mid_m.json 이 있으면 거기서 SLOPE/OFFSET 자동 추정,
    없으면 757 TCP 기준 기본값을 사용한다.
    """
    global _FRAME_SLOPE, _FRAME_OFFSET

    try:
        data = _load_json("data/Frame_x_from_mid_m.json")
        fr1 = float(data["Fr1"])
        x1 = float(data["x1"])
        fr2 = float(data["Fr2"])
        x2 = float(data["x2"])

        _FRAME_SLOPE = (x2 - x1) / (fr2 - fr1)
        _FRAME_OFFSET = x1 - _FRAME_SLOPE * fr1
        print(f"[INFO] Frame mapping: SLOPE={_FRAME_SLOPE:.6f}, OFFSET={_FRAME_OFFSET:.3f}")
    except Exception:
        # Fallback: BUSHRA 757 TCP default (Fr 증가 = FWD, Midship = 30.151)
        _FRAME_SLOPE = -1.0
        _FRAME_OFFSET = 30.151
        print(f"[INFO] Frame mapping: SLOPE={_FRAME_SLOPE:.6f}, OFFSET={_FRAME_OFFSET:.3f} (default)")
```

---

## 2. 간단 Self-check (주석용)

agi_tr.py 맨 아래 디버그 블록에 이런 체크 한 줄 넣어두면,
Frame 축이 제대로 들어갔는지 바로 눈으로 확인할 수 있어.

```python
if __name__ == "__main__":
    _init_frame_mapping()
    print("=" * 60)
    for label, fr in {
        "AP approx"        : 0.0,
        "Midship (Lpp/2)"  : 30.151,
        "FP approx"        : 60.30,
        "FWB1/2 center 55" : 55.0,
    }.items():
        x = fr_to_x(fr)
        print(f"{label:25}  Fr={fr:6.2f}  →  x={x:8.3f} m  ({'FWD' if x < 0 else 'AFT'})")
    print("=" * 60)
```

이 출력이 대략 아래처럼 나오면 **Frame 축 패치 OK**:

* AP 쪽: x ≈ +30 m (AFT)
* Midship: x ≈ 0 m
* FP 쪽: x ≈ -30 m (FWD)
* FWB1/2 (Fr~55): x 음수(FWD)로 찍히는지 확인

---

## 3. 다음 스텝(뭐를 더 봐야 하는지)

1. **Tank 좌표 테이블**

   * `get_fixed_tank_data()` / `tank_coordinates.json` 에 이미 들어가 있는
     `Mid_Fr` 값들이 **757 TCP Frame 번호 그대로인지** 다시 한 번 육안 확인.
2. **Stage 테이블 재생성**

   * 지금은 x_stage_m 를 숫자로 직접 넣어 둔 게 많아서,
     가능하면 `Fr` 기반으로 다시 정의하고 `fr_to_x()`로 변환시키는 쪽이 안전.
3. **캡틴 메일 갱신**

   * 설명 문구는 “FWB1/2 forward (Frames 48–65, FWD part of the vessel)” 쪽으로 정정,
     이 코드 패치와 일관되게 가져가면 된다.

원하면, 이 패치 반영된 **agi_tr.py 전체 버전**도 한 번에 정리해서 덤프해 줄게.
